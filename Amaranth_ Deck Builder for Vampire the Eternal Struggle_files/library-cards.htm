<library-cards class="card-filter mdl-shadow--2dp mdl-color--white">

	<div class="card-header mdl-color--blue-grey-100">
		<div class="mdl-grid mdl-grid--no-spacing">
			
			<div class="mdl-cell mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--1-col-phone">
				<h5>Library  <small if={ cards.length } style="position:absolute;"> { cards.length }</small></h5>
			</div>

			<div class="mdl-cell mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--3-col-phone">

				<label name="settingsbutton" class="card-filter-settings mdl-button mdl-js-button mdl-button--icon" onclick={ toggleoptions }>
					<i class="material-icons"  tabindex="2">&#xE5D4;</i>
				</label>


				<label class="mdl-button  mdl-button--icon mdl-js-button" style="float:right; margin-top:5px;" id="sortlib_btn">
					<i class="material-icons">&#xE8d5;</i>
				</label>

				<ul class="mdl-menu mdl-js-menu mdl-menu--bottom-right" for="sortlib_btn">
					<li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="name">Name</li>
					<li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="type">Type</li>
					<li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="discipline">Discipline</li>
					<li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="clan">Clan</li>
					<li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="rating" if{ app.twda }>Rating</li>
					<!-- <li class="mdl-menu__item" onclick={ sortlibraryby } data-sort="rank" if{ app.twda }>Rank</li> -->
				</ul>				

				<div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
					<label name="searchglass" class="mdl-button mdl-js-button mdl-button--icon" for="searchlib">
						<i class="material-icons">&#xE8B6;</i>
					</label>
					
						
					<div class="mdl-textfield__expandable-holder">
						<i class="material-icons clear_filter_button" tabindex="2" onclick={ clearq } if={ filters.q }>cancel</i>
						<label class="mdl-textfield__label" for="searchlib">Search...</label>
						<input class="mdl-textfield__input" type="text" onkeyup={ search } onchange={ search } onsearch={ search } id="searchlib">
					</div>
				</div>
			</div>
		</div>	
	</div>	


	<div class="card-filter-options mdl-shadow--2dp mdl-color--white " name="filteroptions" >
	
		<div class="mdl-selectfield { showdisciplines ? 'is-focused' : ''}" name="disciplinesEl" onclick={ toggledisciplines }> 

			<label class="mdl-selectfield__label" for="typeselect">Disciplines<span if={ discipline.length }>:</span> { discipline.join(' ') }</label>
			<div class="mdl-selectfield__box" tabindex="1">
				<i class="material-icons" tabindex="-1">arrow_drop_down</i><span class="mdl-selectfield__box-value" tabindex="0"></span>
			</div>

			<div class="mdl-selectfield__list-option-box card-filter-disciplines" onclick={ setdiscipline }  onblur={ hidedisciplines } tabindex="-1">
				<div class="icon-wrapper">

					<icon class="abo" data-discipline="abo"></icon>
					<icon class="ani" data-discipline="ani"></icon>
					<icon class="aus" data-discipline="aus"></icon>
					<icon class="cel" data-discipline="cel"></icon>
					<icon class="chi" data-discipline="chi"></icon>
					<icon class="dai" data-discipline="dai"></icon>
					<icon class="dem" data-discipline="dem"></icon>
					<icon class="dom" data-discipline="dom"></icon>
					<icon class="for" data-discipline="for"></icon>
					<icon class="mal" data-discipline="mal"></icon>
					<icon class="mel" data-discipline="mel"></icon>
					<icon class="myt" data-discipline="myt"></icon>
					<icon class="nec" data-discipline="nec"></icon>
					<icon class="obe" data-discipline="obe"></icon>
					<icon class="obf" data-discipline="obf"></icon>
					<icon class="obl" data-discipline="obl"></icon>
					<icon class="obt" data-discipline="obt"></icon>
					<icon class="pot" data-discipline="pot"></icon>
					<icon class="pre" data-discipline="pre"></icon>
					<icon class="pro" data-discipline="pro"></icon>
					<icon class="qui" data-discipline="qui"></icon>
					<icon class="san" data-discipline="san"></icon>
					<icon class="ser" data-discipline="ser"></icon>
					<icon class="spi" data-discipline="spi"></icon>
					<icon class="str" data-discipline="str"></icon>
					<icon class="tem" data-discipline="tem"></icon>
					<icon class="tha" data-discipline="tha"></icon>
					<icon class="thn" data-discipline="than"></icon>
					<icon class="val" data-discipline="val"></icon>
					<icon class="vic" data-discipline="vic"></icon>
					<icon class="vis" data-discipline="vis"></icon>


				</div>
			</div>
		</div>

		<!-- CARD TYPE -->
		<div class="mdl-selectfield mdl-js-selectfield">
		  <select id="typeselect" class="mdl-selectfield__select" onchange={ settype }>
		    <option value=""></option>
		    <option value="{ type }" each={ type, i in app.cardtypes }>{ type }</option>
		  </select>
		  <label class="mdl-selectfield__label" for="typeselect">Card Type</label>
		</div>

		<!-- CLAN -->
		<div class="mdl-selectfield mdl-js-selectfield">
		  <select id="clanselect" class="mdl-selectfield__select" onchange={ setclan }>
		    <option value=""></option>
		    <option value="{ clan.name }" each={ clan in app.clans }>{ clan.name }</option>
		  </select>
		  <label class="mdl-selectfield__label" for="clanselect">Clan</label>
		</div>

		<div class="mdl-grid mdl-grid--no-spacing">
			<div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--2-col-phone">


				<!-- SET -->
				<div class="mdl-selectfield mdl-js-selectfield">
				  <select id="setselect" class="mdl-selectfield__select" onchange={ setset }>
				    <option value=""></option>
				    <option value="{ set.value }" each={ set in app.sets }>{ set.name }</option>
				  </select>
				  <label class="mdl-selectfield__label" for="setselect">Set</label>
				</div>
			</div>

			<div class="mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet mdl-cell--2-col-phone" if={ 0 } >

				<!-- STORYLINE -->
				<div class="mdl-selectfield mdl-js-selectfield">
				  <select id="storyselect" class="mdl-selectfield__select" onchange={ setstoryline }>
				    <option value=""></option>
				    <option value="{ storyline.name }" each={ storyline in app.stories }>{ storyline.name }</option>
				  </select>
				  <label class="mdl-selectfield__label" for="storyselect">Storyline</label>
				</div>
			</div>
		</div>

		<!-- PATH -->
		<div class="mdl-grid mdl-grid--no-spacing" style="margin-bottom: 5px;margin-top: 5px;">

			<div class="mdl-cell mdl-cell--6-col mdl-cell--2-col-tablet mdl-cell--1-col-phone">
				<label style="color: rgba(0, 0, 0, 0.25);     font-size: 16px;">Path</label>
			</div>
			<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--3-col-phone" style="padding-left:10px;" onclick={ setpath } >
				
				<div class="icon-wrapper path-selector">
						<icon class="CAINE" title="CAINE"></icon>
						<icon class="CATHARI" title="CATHARI"></icon>
						<icon class="DEATH_AND_THE_SOUL" title="DEATH AND THE SOUL"></icon>
						<icon class="POWER_AND_THE_INNER_VOICE" title="POWER AND THE INNER VOICE"></icon>				
				</div>
			</div>
		</div>

		<div class="mdl-color-text--grey-400">


			<!-- BLOOD COST -->
			<div class="mdl-selectfield mdl-js-selectfield" if={ 0 }>
			  <select id="bloodselect" class="mdl-selectfield__select" onchange={ setblood }>
			    <option value=""></option>
			    <option value="Yes">Costs blood</option>
			    <option value="No">Does't cost blood</option>
			  </select>
			  <label class="mdl-selectfield__label" for="bloodselect">Blood Cost</label>
			</div>


			<!-- BLOOD COST -->
			<div class="mdl-selectfield mdl-js-selectfield" if={ 0 }>
			  <select id="bloodselect" class="mdl-selectfield__select" onchange={ setpool }>
			    <option value=""></option>
			    <option value="Yes">Costs pool</option>
			    <option value="No">Doesn't cost pool</option>
			  </select>
			  <label class="mdl-selectfield__label" for="bloodselect">Pool Cost</label>
			</div>


			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Bleed">
			  <input type="checkbox" id="Bleed" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">+Bleed</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Titled">
				  <input type="checkbox" id="Titled" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Titled</span>
				</label>					

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Strength">
			  <input type="checkbox" id="Strength" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">+Strength</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Blackhand">
				  <input type="checkbox" id="Blackhand" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Black Hand</span>
				</label>

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Stealth">
			  <input type="checkbox" id="Stealth" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">+Stealth</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Anarch">
				  <input type="checkbox" id="Anarch" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Anarch</span>
				</label>

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Intercept">
			  <input type="checkbox" id="Intercept" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">+Intercept</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Red_list">
				  <input type="checkbox" id="Red_list" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Red list</span>
				</label>		

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Aggravated">
			  <input type="checkbox" id="Aggravated" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">Aggravated</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Infernal">
				  <input type="checkbox" id="Infernal" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Infernal</span>
				</label>							

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Enter_combat">
			  <input type="checkbox" id="Enter_combat" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">Enter&nbsp;combat</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Slave">
				  <input type="checkbox" id="Slave" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Slave</span>
				</label>				

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Multi">
			  <input type="checkbox" id="Multi" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">Multi&nbsp;disc</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Combo">
				  <input type="checkbox" id="Combo" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Combo</span>
				</label>

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="NoDisc">
			  <input type="checkbox" id="NoDisc" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">No&nbsp;disc</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Flight">
				  <input type="checkbox" id="Flight" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Flight</span>
				</label>

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Clanless">
			  <input type="checkbox" id="Clanless" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">Clanless</span>
			</label>


				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Burnable">
				  <input type="checkbox" id="Burnable" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Burnable</span>
				</label>

			<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="Banned">
			  <input type="checkbox" id="Banned" class="mdl-checkbox__input" onchange={ togglefilter }>
			  <span class="mdl-checkbox__label">Banned</span>
			</label>

				<label class="mdl-checkbox mdl-js-checkbox mdl-cell--6-col mdl-cell--4-col-tablet mdl-cell--2-col-phone" for="PT" if={ app.user && app.user.pt }>
				  <input type="checkbox" id="PT" class="mdl-checkbox__input" onchange={ togglefilter }>
				  <span class="mdl-checkbox__label">Playtest</span>
				</label>				
		</div>

		<div class="mdl-grid _mdl-grid--no-spacing card-filter-buttons ">
			<div class="mdl-cell mdl-cell--6-col  mdl-cell--4-col-tablet mdl-cell--2-col-phone">
				<button class="mdl-button mdl-js-button mdl-button--raised" onclick={ clear }  style="width:100%; ">
					Clear
				</button>
			</div>
						
			<div class="mdl-cell mdl-cell--6-col  mdl-cell--4-col-tablet mdl-cell--2-col-phone">
				<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"  onclick={ done } style="width:100%; ">
					Done
				</button>
			</div>
			
		</div>

	</div>

		<div class="card-content"  onmousedown={ hideoptions } onscroll={ onscroll }>
			<div class="mdl-grid mdl-grid--no-spacing">

				<div class="mdl-cell mdl-cell--12-col" if={ cards.length }>

					<div class="picker-list mdl-list">
						<div class="mdl-list__item"	each={ showcards || cards }>
							<span class="mdl-list__item-primary-content" onclick={ showcard }>
								<span>{ name } <icon class={ path && path.split(' ').join('_') } if={ path } title={ path } style="font-size: 24px;margin-bottom: -8px;margin-top: -8px; margin-left:-4px"></icon> <span class="banned" if={ banned }>Banned</span> <span class="banned" if={ path }>Not Legal</span> </span>
							</span>

							<span class="mdl-list__item-secondary-content">
								<span>{ disc || clan } { type }</span>
								<span if={ rating }>{ rating } / 100</span>
							</span>

							<!-- Icon button -->
							<button class="mdl-button mdl-js-button mdl-button--icon mdl-list__item-secondary-action" onclick={ removecard } if={ deck && !deck.readonly }>
								<i class="material-icons">&#xE15C;</i>
							</button>

							<span class="picker-total total_in_deck mdl-list__item-secondary-action" if={ deck }>{ parent.deck.cards[ id ] || 0 }</span>
								

							<button class="mdl-button mdl-js-button mdl-button--icon mdl-list__item-secondary-action" onclick={ addcard } if={ deck && !deck.readonly }>
								<i class="material-icons">&#xE147;</i>
							</button>

						</div>
					</div>
				</div>
			</div>
	
		</div>

	</div>


	<script>
	
	this.mixin(amaranth_util.prototype)	
			
	this.chunksize = 150

	if(opts.deck && false) {
		// Require search
		this.cards = []
	} 
	else {
		// Grab all library cards
		this.cards = app.librarycards(
			function(card){
				return card.pt != 1 && !card.storyline
			}
		)

		if(this.cards.length > this.chunksize) {
			this.showcards = this.cards.slice(0, this.chunksize)
		} else {
			this.showcards = null 
		}			
	}

	this.lastq = ''
	this.showdisciplines = false 

	this.mnt       = opts.mnt
	this.deck      = opts.deck // || app.deck 
	this.chunksize = 100 
	this.filters   = {discipline: [], path: []}

	done(e) {
		if($(document).width() >= 1024 && $(this.root).parents('.modal').length) {
			app.hidemodal()
			this.unmount()
		} else {
			this.toggleoptions(e)
		}
	}

	toggleoptions(e) {
		e.preventUpdate = true
		$(this.filteroptions).toggleClass('is-active')
		return true
	}

	showoptions(e) {
		e.preventUpdate = true
		clearInterval(this.hideOptsInt)
		$(this.filteroptions).addClass('is-active')

		this.hidedisciplines()

		// if(this.showdisciplines) {
		// 	this.showdisciplines = false 
		// 	$(this.disciplinesEl).removeClass('is-focused').find('i').html('arrow_drop_down')	
		// }


	}

	hideoptions(e) {
		e.preventUpdate = true
		$(this.filteroptions).removeClass('is-active')
		return true 
	}

	toggledisciplines(e) {

		e.stopPropagation()

		if(!this.showdisciplines) {
			this.showdisciplines = true  
			$(this.disciplinesEl).addClass('is-focused').find('i').html('arrow_drop_up')	
			$(this.disciplinesEl).find('.card-filter-disciplines').focus()		
			this.hideselects(e)
		}

		e.preventUpdate = true
	
	}

	hidedisciplines(e){
		e.preventUpdate = true
		setTimeout(function(){this.showdisciplines = false}.bind(this),100)
		$(this.disciplinesEl).removeClass('is-focused').find('i').html('arrow_drop_down')	
	}

	hideselects(e){
		e.preventUpdate = true
		$(this.root).find('.mdl-js-selectfield').removeClass('is-focused')
	}

	onscroll(e) {

		this.hideoptions(e)

		e.preventUpdate   = true
		var chunkevery    = this.chunksize
		var elementheight = 35
		var chunk         = Math.floor(e.target.scrollTop / (chunkevery * elementheight)) 

		if(chunk > (this.lastchunk || 0)) {
			this.showcards  = this.cards.slice(0, chunkevery * (chunk + 1))
			this.lastchunk  = chunk
			e.preventUpdate = false 
		}
	}	

	delayhideoptions(e) {
		e.preventUpdate = true

		this.hideOptsInt = setTimeout(function(){
								$(this.filteroptions).removeClass('is-active')
							}.bind(this), 50)
	}

	sortlibraryby(e){
		e.preventUpdate = true 
		e.preventDefault()
		var order = $(e.target).data('sort')
		this.libraryorder = order

		console.log('sortlibraryby', order)

		if(this.libraryorder) {
			app.sortlibrary(this.cards, this.libraryorder)
			this.showcards = this.cards.slice(0, ((this.lastchunk || 0) + 1) * 250)
		}

		this.update()
	}

	showcard(e) {
		e.preventUpdate = true
		var card = e.item 
		var dom = document.createElement('card')
		app.setmodal(dom, function(modal){
			modal.css('overflow-y', 'auto').addClass('card').addClass('large')
		})
		
		riot.route(window.location.hash.split('#')[1] + '/card')
		
		riot.mount(dom, 'card', {card: card, cards: this.cards, deck: this.deck, mnt: this })
	} 

	setclan(e) {
		e.preventUpdate = true
		this.filters.clan = $(e.target).val()		
		this.filter()		
	}	

	setset(e) {
		e.preventUpdate = true
		this.filters.set = $(e.target).val()		
		this.filter()		
	}	

	setstoryline(e) {
		e.preventUpdate = true
		this.filters.storyline = $(e.target).val()		
		this.filter()		
	}	

	settype(e) {
		e.preventUpdate = true
		this.filters.type = $(e.target).val()		
		this.filter()		
	}	

	setdiscipline(e) {
		e.preventUpdate = true
		e.preventDefault()
		e.stopPropagation()

		if(e.target.nodeName == 'ICON') {
			var n = $(e.target)
			var d = n.data('discipline')
			var disciplines = this.discipline

			console.log('disciplines',disciplines)
			
			switch(true) {

				case n.hasClass('inf'):
					this.remove_discipline(d)
					n.removeClass('inf')
					break

				default: 
					this.add_discipline(d)
					n.addClass('inf')
			}
		}
		this.filter()
	}

	remove_discipline(d) {		
		var i = this.filters.discipline.indexOf(d);
		if (i >= 0) {
		  this.filters.discipline.splice(i, 1 );
		}		
	}

	add_discipline(d) {
		var i = this.filters.discipline.indexOf(d);
		if (i == -1) {
		  this.filters.discipline.push(d);
		}	
	}

	setpath(e) {
		e.preventUpdate = true
		e.preventDefault()
		e.stopPropagation()

		if(e.target.nodeName == 'ICON') {
			var n = $(e.target)
			var d = n.attr('title')			
			switch(true) {

				case n.hasClass('active'):
					this.remove_path(d)
					n.removeClass('active')
					break

				default: 
					this.add_path(d)
					n.addClass('active')
			}
		}
		this.filter()
	}

	remove_path(d) {		
		var i = this.filters.path.indexOf(d);
		if (i >= 0) {
		  this.filters.path.splice(i, 1 );
		}		
	}

	add_path(d) {
		var i = this.filters.path.indexOf(d);
		if (i == -1) {
		  this.filters.path.push(d);
		}	
	}



	addcard(e) {
		e.preventUpdate = true
		var card = e.item 
		var qty = (this.deck.cards[card.id] + 1 || 1)

		$(e.target).parents('div:first').find('.total_in_deck').html(qty)
		this.deck.dirty = 1
		this.deck.cards[card.id] = qty
		app.trigger('deckchange')
		app.save()
	}

	removecard(e) {
		e.preventUpdate = true
		var card = e.item 
		var qty = Math.max((this.deck.cards[card.id] - 1 || 0),0)
		
		$(e.target).parents('div:first').find('.total_in_deck').html(qty)
		this.deck.dirty = 1
		this.deck.cards[card.id] = qty
		app.trigger('deckchange')
		app.save()
	}




	clearq(e){
		this.searchlib.value = ''
		e.preventUpdate = true 
		this.filters.q = ''
		this.filter()
	}


	clear(e) {
		e.preventUpdate = true 
		
		this.filters         = {discipline: []}
		this.lastchunk       = 0
		this.showdisciplines = false 

		//this.toggleoptions(e)
		$(this.root).find('#searchlib').val('').trigger('blur')
		$(this.filteroptions).find('.inf').removeClass('inf')		
		$(this.filteroptions).find('.mdl-js-selectfield.is-dirty').each(function(i, el){
			$(el).removeClass('is-dirty')
			$(el).find('.mdl-selectfield__box-value').html('')
		})
		$(this.filteroptions).find('input[type=checkbox]:checked').click()
		$(this.filteroptions).find('input[type=range]').val(0).trigger('click')

		this.filter()
	}


	search(e){
		e.preventUpdate = true 
		this.filters.q = e.target.value.trim() 
		this.filter()
	}

	filter() {
	
		var filters = this.filters
		var hash    = []
		
		filters.islibrary = 1

		for(key in filters){
			hash.push(filters[key])
		}

		hash = hash.join('.')

		if(this.lasthash == hash){
			return 
		}

		clearInterval(this.filterInt)

		this.filterInt = setTimeout(function(){ 	
			this.last_hash = hash

			this.cards = this.find_cards(this.filters)

			console.log('this.cards.length', this.cards.length)
			
			// Only triggered on hash change
			if(this.libraryorder) {
				app.sortlibrary(this.cards, this.libraryorder)
			}

			if(this.cards.length > this.chunksize) {
				this.showcards = this.cards.slice(0, this.chunksize)
				this.lastchunk = 0
			} else {
				this.showcards = null 
				this.lastchunk = 0
			}

			this.update()			

		}.bind(this), 350)
	}


	this.on('update', function(){
      var x = new Date().getTime();
      setTimeout( function() {
		componentHandler.upgradeDom();
        console.log('library.update' , ( new Date().getTime() - x ) + 'ms');
      },1);		
	})

	this.on('mount', function(){
		componentHandler.upgradeDom();
		
		if(this.deck && !app.iscordova) {
			setTimeout(function(){
				this.searchglass.click()
			}.bind(this),1)
		}

	})
	</script>



</library-cards>
