<login class="mdl-c ard mdl-color--white">
	
	<div class="mdl-card__title mdl-color--primary mdl-color-text--white">
		<h2 class="mdl-card__title-text">Login / Create Account</h2>
	</div>

		<div class="mdl-card__supporting-text">
		<form action="#">
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="email" id="email" onkeydown={ checkenter } />
				<label class="mdl-textfield__label" for="email">Email</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="password" id="password" onkeydown={ checkenter }/>
				<label class="mdl-textfield__label" for="password">Password</label>
			</div>
		</form>
	</div>

	<div class="mdl-card__actions">
		<button class="mdl-button mdl-js-button mdl-button--right mdl-button--raised mdl-button--accent" onclick={ login }>Login</button>
		<button class="mdl-button mdl-js-button mdl-button--right mdl-button--raised mdl-button--colored"  onclick={ register }>Register</button>
		<button class="mdl-button mdl-js-button mdl-button--right mdl-button--fab mdl-button--mini-fab" style="margin-top: -3px;" onclick={ lost } ><i class="material-icons">&#xE001;</i></button>

		<button class="mdl-button mdl-button--colored  mdl-js-button" onclick={ cancel }>Cancel</button>
	</div>

	<script>

	this.onsuccess = opts.onsuccess 


	cancel(e) {
		app.hidemodal()
		e.preventUpdate = true 
		setTimeout(function(){
			this.unmount()
		}.bind(this), 300)
	}

	onSuccess(response) {
		app.user    = response.result.user 
		app.session = response.result.session				
		app.offset  = ''
		store.set('user', app.user)
		store.set('session', app.session)
		store.set('offset', '')

		if(this.onsuccess) {
			this.onsuccess()
		}
		app.hidemodal()
		
		this.unmount()

	}

	lost(e) {
		e.preventUpdate = true 

		var inp = this.email 
		var email = inp.value 
		
		swal({
			type: 'warning',
			text: 'Reset password?',
			showConfirmButton: true,
			confirmButtonText: 'Yes',
			showCancelButton: true,
			cancelButtonText: 'No' 
		}).then(function(isconfirmed){

			if(email == '') {
				inp.focus()
				return swal({type:'error', text: 'Please enter an email address', timer: 1500}).done()
			}

			if(!~email.indexOf('@')) {
				inp.focus()
				return swal({type:'error', text: 'Please check the email address', timer: 1500}).done()
			}

		

			app.callapi('/api/forgot', {
	 	 	 	email: this.email.value
			}, function(response) {

				// Logged in OK
				if(response.success) {
					swal({
						type: 'success',
						text: (response.error ? response.error.message : 'A reset passwword email has sent to your address.')
					}).done()

					app.hidemodal()
		
					this.unmount()

				} else {
					swal({
						type: 'error',
						text: (response.error ? response.error.message : 'Opps, there\'s been an error.'),
						timer: 5 * 1000
					}).done()				
				}
			})



		})

	}

	login(e) {
		e.preventUpdate = true 

		app.callapi('/api/login', {
			email:    this.email.value,
			password: this.password.value,
			deviceid: app.deviceid
		}, function(response) {

			// Logged in OK
			if(response.success) {
				swal({
					type: 'success',
					text: (response.error ? response.error.message : 'Logged in.'),
					timer: 2 * 1000
				}).done()



				app.hidemodal()

				setTimeout(function(){
					this.onSuccess(response)
				}.bind(this), 2700)
			}

			// Error
			else {
				swal({
					type: 'error',
					text: (response.error ? response.error.message : 'Opps, there\'s been an error.'),
					timer: 5 * 1000
				}).done()				
			}
		}.bind(this))
	}

	checkenter(e) {
		e.preventUpdate = true 
		if(e.keyCode == 13) {
			this.login(e)
		}
		return true 
	}

	register(e) {
		e.preventUpdate = true 

		app.callapi('/api/register', {
			email:    this.email.value,
			password: this.password.value,
			deviceid: app.deviceid
		}, function(response) {

			// Registered OK
			if(response.success) {
				swal({
					type: 'success',
					text: (response.error ? response.error.message : 'Registered successfully.'),
					timer: 3 * 1000
				}).done()

				app.hidemodal()

				setTimeout(function(){
					this.onSuccess(response)
				}.bind(this), 3300)
			}

			// Error
			else {
				swal({
					type: 'error',
					text: (response.error ? response.error.message : 'Opps, there\'s been an error.'),
					timer: 5 * 1000
				}).done()				
			}
		}.bind(this))
	}




	this.on('mount', function(){
		this.email.focus()
		componentHandler.upgradeDom();
	})


	</script>

	<style>
	.mdl-button--right{
		float: right;
		margin-left: 10px;
	}


	</style>

</login>
